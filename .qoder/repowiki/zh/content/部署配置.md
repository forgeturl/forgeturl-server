# 部署配置

<cite>
**本文档引用文件**  
- [Dockerfile](file://Dockerfile)
- [local.toml](file://app/conf/local.toml)
- [forgeturl-service-prod.service](file://app/conf/forgeturl-service-prod.service)
- [forgeturl-service-test.service](file://app/conf/forgeturl-service-test.service)
- [main.go](file://app/main.go)
</cite>

## 目录
1. [简介](#简介)
2. [Docker 部署指南](#docker-部署指南)
3. [传统裸机部署指南](#传统裸机部署指南)
4. [环境变量与多环境支持](#环境变量与多环境支持)
5. [总结](#总结)

## 简介
本文档提供针对 `forgeturl-server` 项目的详细部署说明，涵盖基于 Docker 的容器化部署和传统裸机部署两种方式。内容包括 Dockerfile 指令解析、多阶段构建优势、配置文件设置、systemd 服务管理以及环境变量覆盖机制，确保项目可在开发、测试、生产等多环境中灵活部署。

## Docker 部署指南

### Dockerfile 指令详解
本项目采用多阶段构建（multi-stage build）优化镜像体积与构建效率，具体指令解析如下：

1. **基础构建镜像**  
   ```Dockerfile
   FROM sunmi-docker-images-registry.cn-hangzhou.cr.aliyuncs.com/public/golang:1.18.10 As builder
   ```
   使用 Go 1.18.10 作为构建阶段的基础镜像，并命名为 `builder`，便于后续阶段引用。

2. **Go 模块依赖缓存优化**  
   ```Dockerfile
   WORKDIR /go/cache
   ADD app/go.mod .
   ADD app/go.sum .
   RUN go mod download
   ```
   先将 `go.mod` 和 `go.sum` 文件复制并下载依赖，利用 Docker 层缓存机制：仅当依赖文件变更时才重新下载，显著提升后续构建速度。

3. **项目代码构建**  
   ```Dockerfile
   WORKDIR /project
   ADD ./app/ .
   RUN go build main.go
   ```
   将应用代码复制到工作目录并编译生成二进制文件 `main`，此步骤依赖前一阶段的缓存，避免重复拉取依赖。

4. **精简运行时镜像**  
   ```Dockerfile
   FROM sunmi-docker-images-registry.cn-hangzhou.cr.aliyuncs.com/public/debian:stable-slim
   WORKDIR /app
   COPY --from=builder /project/main .
   CMD [ "/app/main","api","start"]
   ```
   使用轻量级 Debian 镜像作为运行环境，仅复制编译好的二进制文件，极大减小最终镜像体积，提升安全性与部署效率。

5. **端口暴露与启动命令**  
   虽未显式使用 `EXPOSE` 指令，但服务实际监听配置文件中定义的端口（默认 80）。启动命令通过 `CMD` 执行二进制并传入 `api start` 子命令，触发 API 服务启动逻辑。

### docker-compose 集成部署示例
尽管项目根目录未提供 `docker-compose.yml`，以下为推荐的集成 MySQL 与 Redis 的部署配置：

```yaml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "80:80"
    environment:
      - RUN_TIME=prod
      - MYSQL_HOST=mysql
      - REDIS_HOST=redis
    depends_on:
      - mysql
      - redis
    restart: always

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: pwdTest
      MYSQL_DATABASE: forget_url
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

volumes:
  mysql_data:
  redis_data:
```

该配置实现服务编排，确保依赖服务就绪后启动主应用，并通过环境变量覆盖数据库与 Redis 地址。

**Section sources**
- [Dockerfile](file://Dockerfile#L1-L24)

## 传统裸机部署指南

### 编译二进制文件
在目标服务器上执行以下命令完成编译：
```bash
cd app
go build main.go
```
生成的 `main` 可执行文件可用于直接启动服务。

### 配置文件说明
项目使用 `app/conf/local.toml` 作为本地配置文件，关键参数如下：

- **网络配置**  
  ```toml
  [network]
  ApiServiceHost = "0.0.0.0"
  ApiServicePort = "80"
  ```
  定义服务监听地址与端口。

- **MySQL 配置**  
  ```toml
  [mysql]
  Host = "127.0.0.1"
  Port = "3306"
  Name = "forget_url"
  User = "root"
  Passwd = "pwdTest"
  ```
  数据库连接信息，需确保数据库已初始化并创建对应表结构。

- **Redis 配置**  
  ```toml
  [redisServer]
  host = "127.0.0.1"
  port = ":6379"
  auth = ""
  ```
  Redis 服务地址与认证信息，用于缓存与分布式锁。

**Section sources**
- [local.toml](file://app/conf/local.toml#L1-L30)

### 使用 systemd 进行进程管理
项目提供 systemd 服务配置文件，适用于生产环境长期运行。

#### 示例配置（生产环境）
```ini
[Unit]
[Service]
LimitNOFILE=1048576
WorkingDirectory=/data/app/forgeturl-server/test/main
Environment=RUN_TIME=onl
Environment=APP_NAME=forgeturl-server-prod
ExecStart=/data/app/forgeturl-server/test/main/forgeturl-server api start
Restart=always
[Install]
WantedBy=default.target
```
- `WorkingDirectory`：指定工作目录  
- `Environment`：设置运行时环境变量  
- `ExecStart`：启动命令  
- `Restart=always`：崩溃后自动重启  

#### 部署步骤
1. 将二进制文件复制至 `/data/app/forgeturl-server/test/main`
2. 将 `.service` 文件复制至 `/etc/systemd/system/`
3. 启用并启动服务：
   ```bash
   systemctl daemon-reexec
   systemctl enable forgeturl-service-prod.service
   systemctl start forgeturl-service-prod
   ```

**Section sources**
- [forgeturl-service-prod.service](file://app/conf/forgeturl-service-prod.service#L1-L12)
- [forgeturl-service-test.service](file://app/conf/forgeturl-service-test.service#L1-L12)

## 环境变量与多环境支持
项目支持通过环境变量覆盖配置文件中的参数，实现多环境灵活部署。例如：
- `MYSQL_HOST` 覆盖 `[mysql] Host`
- `REDIS_HOST` 覆盖 `[redisServer] host`
- `RUN_TIME` 指定运行环境（如 `test`, `onl`）

在 `app/pkg/core/env.go` 中实现环境变量读取逻辑，优先级高于配置文件，便于 CI/CD 流水线中动态注入配置。

此外，`main.go` 中通过 `urfave/cli` 解析命令行参数，支持 `api start` 等子命令，结合环境变量实现灵活启动模式。

**Section sources**
- [main.go](file://app/main.go#L1-L33)
- [provider.go](file://app/pkg/connector-provider/provider.go#L36-L37)

## 总结
`forgeturl-server` 提供了完善的部署支持，包括：
- Docker 多阶段构建，优化镜像体积与构建速度
- 支持 MySQL 与 Redis 的容器编排示例
- 裸机部署的二进制编译与 systemd 服务管理
- 环境变量覆盖机制，适配多环境部署需求

通过合理配置 `local.toml` 与环境变量，可快速在开发、测试、生产环境中部署服务，确保系统稳定运行。