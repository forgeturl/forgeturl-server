# 快速入门指南

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [local.toml](file://app/conf/local.toml)
- [Dockerfile](file://Dockerfile)
- [genapi.sh](file://app/genapi.sh)
- [main.go](file://app/main.go)
- [api.go](file://app/cmd/api.go)
- [redis.go](file://app/dal/redis.go)
- [user.go](file://app/dal/user.go)
- [router.go](file://app/route/router.go)
</cite>

## 目录
1. [简介](#简介)
2. [本地环境搭建与启动](#本地环境搭建与启动)
3. [Docker 构建与运行](#docker-构建与运行)
4. [接口调用与功能验证](#接口调用与功能验证)
5. [安全提醒](#安全提醒)
6. [常见问题](#常见问题)

## 简介
本指南旨在帮助新手开发者在 10 分钟内完成 `forgeturl-server` 服务的本地部署与首次接口调用。内容涵盖从代码克隆、环境配置、API 代码生成、服务编译启动，到使用 `curl` 验证核心接口的完整流程。同时提供 Docker 部署方案，确保开发环境快速可复制。

## 本地环境搭建与启动

### 1. 克隆仓库
首先，将项目代码克隆到本地：
```bash
git clone https://github.com/your-repo/forgeturl-server.git
cd forgeturl-server
```

### 2. 安装 Go 环境
确保已安装 **Go 1.18 或更高版本**。可通过以下命令验证：
```bash
go version
```
若未安装，请前往 [Go 官方网站](https://golang.org/dl/) 下载并安装。

### 3. 配置数据库与 Redis
编辑配置文件 `app/conf/local.toml`，根据您的本地环境修改 MySQL 和 Redis 的连接参数。

**数据库配置示例**:
```toml
[mysql]
Host = "127.0.0.1"
Port = "3306"
Name = "forget_url"
User = "root"
Passwd = "your_password"
```

**Redis 配置示例**:
```toml
[redisServer]
host = "127.0.0.1"
port = ":6379"
auth = ""
```

请确保 MySQL 和 Redis 服务已在本地运行，并创建好名为 `forget_url` 的数据库。

### 4. 生成 API 代码
运行 `genapi.sh` 脚本以生成基于 Protobuf 的 API 代码：
```bash
cd app
./genapi.sh
```
该脚本会自动检查并安装必要的 Protobuf 编译器（protoc）及插件，然后生成 `api` 目录下的 Go 代码和 OpenAPI 文档。

**Section sources**
- [genapi.sh](file://app/genapi.sh#L1-L65)
- [api/proto/space.proto](file://app/api/proto/space.proto)
- [api/proto/login.proto](file://app/api/proto/login.proto)

### 5. 编译与启动服务
在 `app` 目录下执行编译：
```bash
go build main.go
```
编译成功后，启动服务：
```bash
./main api start
```
服务默认在 `0.0.0.0:80` 启动，可通过 `local.toml` 中的 `[network]` 配置修改。

**Section sources**
- [main.go](file://app/main.go#L1-L33)
- [api.go](file://app/cmd/api.go#L1-L66)

## Docker 构建与运行

### 构建镜像
在项目根目录执行以下命令构建 Docker 镜像：
```bash
docker build -t forgeturl-server .
```

### 运行容器
构建完成后，运行容器并映射端口：
```bash
docker run -p 80:80 forgeturl-server
```
此命令将启动服务并监听宿主机的 80 端口。

**Section sources**
- [Dockerfile](file://Dockerfile#L1-L25)

## 接口调用与功能验证

服务启动后，可使用 `curl` 命令调用接口进行功能验证。以下示例均基于 `README.md` 提供的测试用例。

### 非登录态接口调用

#### 获取用户信息
```bash
curl '127.0.0.1:80/space/getUserInfo' -d '{"uid": 1}' -H 'content-type: application/json'
```

#### 获取页面数据
```bash
curl '127.0.0.1:80/space/getPage' -d '{"page_id": "test_page_id"}' -H 'content-type: application/json'
```

### 登录态接口调用（使用测试 Token）

#### 获取用户信息（带 Token）
```bash
curl '127.0.0.1:80/space/getUserInfo' -d '{"uid": 1}' -H 'content-type: application/json' -H 'X-Token: test'
```

#### 拉取我的空间
```bash
curl '127.0.0.1:80/space/getMySpace' -d '{"uid": 1}' -H 'content-type: application/json' -H 'X-Token: test'
```

#### 创建页面
```bash
curl '127.0.0.1:80/space/createPage' -d '{
  "title": "我的页面",
  "brief": "这是一个测试页面",
  "collections": [
    {
      "links": [
        {
          "title": "示例链接",
          "url": "https://example.com",
          "tags": ["示例", "测试"]
        }
      ]
    }
  ]
}' -H 'content-type: application/json' -H 'X-Token: test'
```

**Section sources**
- [README.md](file://README.md#L15-L128)
- [router.go](file://app/route/router.go#L1-L18)
- [redis.go](file://app/dal/redis.go#L1-L92)
- [user.go](file://app/dal/user.go#L1-L42)

## 安全提醒
- **测试 Token**: 上述示例中使用的 `'X-Token: test'` 仅为开发测试用途。`redis.go` 中的 `GetXToken` 函数通过 Redis 验证 Token，但在测试模式下 `'test'` 被硬编码为有效 Token。
- **生产环境**: 在生产环境中，**必须**替换为安全的鉴权机制，如 JWT 或 OAuth2，并移除测试 Token 的硬编码逻辑。
- **配置安全**: 请勿将 `local.toml` 中的数据库密码等敏感信息提交至版本控制。

## 常见问题

### 1. `genapi.sh` 脚本执行失败
- 确保已安装 `protoc` 24.2 版本。
- 确保 `protoc-gen-go`、`protoc-gen-go-gin` 等插件已正确安装并位于 `$GOPATH/bin` 目录下。
- 可尝试手动执行脚本中提示的 `go install` 命令。

### 2. 服务启动失败，提示数据库连接错误
- 检查 `local.toml` 中的 MySQL 配置是否正确。
- 确认 MySQL 服务正在运行，并且用户有权限访问 `forget_url` 数据库。

### 3. 接口返回 404 或 500 错误
- 确认服务已成功启动，`./main api start` 命令无报错。
- 检查 `router.go` 是否正确注册了所有 API 路由。