name: Deploy and Rollback

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      action:
        description: "é€‰æ‹©è¦æ‰§è¡Œçš„æ“ä½œ"
        required: true
        default: "rollback"
        type: choice
        options:
          - rollback
      target:
        description: "å›æ»šåˆ°å“ªä¸ªç‰ˆæœ¬ç›®å½• (blue æˆ– green)"
        required: false
        default: "blue"
        type: choice
        options:
          - blue
          - green

jobs:
  # =============================
  # éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
  # =============================
  deploy-test:
    if: github.event_name == 'push'
    name: Deploy to Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: app/go.mod
          cache: true

      - name: Build Go binary
        run: |
          cd app
          go mod download
          mkdir -p ../bin
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o ../bin/forgeturl-server .
          file ../bin/forgeturl-server || true

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ECS_KEY }}

      - name: Add ECS host to known_hosts
        run: |
          ssh-keyscan -H ${{ secrets.ECS_HOST }} >> ~/.ssh/known_hosts
          
      - name: Debug SSH Configuration
        run: |
          echo "=== SSH Debug Information ==="
          echo "SSH Agent PID: $SSH_AGENT_PID"
          echo "SSH Auth Sock: $SSH_AUTH_SOCK"
          echo "Available SSH keys:"
          ssh-add -l || echo "No keys found in ssh-agent"
          echo ""
          echo "SSH Client Version:"
          ssh -V
          echo ""
          echo "Testing SSH connection with verbose output:"
          ssh -vvv -o ConnectTimeout=10 -o StrictHostKeyChecking=no -o BatchMode=yes ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }} "echo 'SSH connection test successful'" 2>&1 | head -50 || echo "SSH connection failed"

      - name: Prepare Server Environment
        run: |
          # è®¾ç½®ç¯å¢ƒå˜é‡é¿å… tput è­¦å‘Š
          export TERM=xterm-256color
          
          # æ£€æŸ¥å¹¶å®‰è£… rsync
          echo "Checking rsync on server..."
          ssh ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }} "
            export TERM=xterm-256color
            if ! command -v rsync &> /dev/null; then
              echo 'rsync not found, installing...'
              sudo apt-get update -qq
              sudo apt-get install -y rsync
              echo 'rsync installed successfully'
            else
              echo 'rsync already installed'
            fi
            rsync --version | head -1
          "

      - name: Deploy to Test Environment
        run: |
          # è®¾ç½®ç¯å¢ƒå˜é‡é¿å… tput è­¦å‘Š
          export TERM=xterm-256color
          
          echo "Uploading Go binary to test environment..."
          rsync -avz ./bin/forgeturl-server ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }}:/data/app/forgeturl-server/test/main/
          
          echo "Uploading systemd service file..."
          rsync -avz ./app/conf/forgeturl-service-test.service ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }}:/data/app/forgeturl-server/test/main/conf/
          
          echo "Installing/updating systemd service file..."
          ssh ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }} "
            export TERM=xterm-256color
            SERVICE_FILE='/etc/systemd/system/forgeturl-server-test.service'
            SOURCE_FILE='/data/app/forgeturl-server/test/main/conf/forgeturl-service-test.service'
            
            # æ£€æŸ¥æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ ! -f \$SOURCE_FILE ]; then
              echo 'âŒ Service source file not found: \$SOURCE_FILE'
              exit 1
            fi
            
            # æ£€æŸ¥æ˜¯å¦éœ€è¦å®‰è£…æˆ–æ›´æ–°æœåŠ¡æ–‡ä»¶
            if [ ! -f \$SERVICE_FILE ]; then
              echo 'ğŸ“¦ Installing new service file...'
              sudo cp \$SOURCE_FILE \$SERVICE_FILE
              sudo systemctl daemon-reload
              echo 'âœ… Service file installed'
            else
              # æ¯”è¾ƒæ–‡ä»¶å†…å®¹
              if ! cmp -s \$SOURCE_FILE \$SERVICE_FILE; then
                echo 'ğŸ”„ Service file content differs, updating...'
                sudo cp \$SOURCE_FILE \$SERVICE_FILE
                sudo systemctl daemon-reload
                echo 'âœ… Service file updated'
              else
                echo 'âœ… Service file content is identical, skipping update'
              fi
            fi
          "
          
          echo "Restarting test service..."
          ssh ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }} "
            export TERM=xterm-256color
            sudo systemctl restart forgeturl-server-test.service
            sleep 2
            sudo systemctl status forgeturl-server-test.service --no-pager
          "
          
          echo "âœ… Test environment deployed at /data/app/forgeturl-server/test/main"

  # =============================
  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ (è“ç»¿å‘å¸ƒ)
  # =============================
  deploy-prod:
    if: github.event_name == 'push'
    name: Deploy to Production (Blue-Green)
    runs-on: ubuntu-latest
    needs: deploy-test
    permissions:
      issues: write
      contents: read

    steps:
      - name: Wait for manual approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: guoming0000
          minimum-approvals: 1
          issue-title: "Approve deploy to production (blue-green)"
          issue-body: "è¯·ç¡®è®¤æµ‹è¯•ç¯å¢ƒæ— è¯¯åï¼Œæ‰¹å‡†å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒã€‚"

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: app/go.mod
          cache: true

      - name: Build Go binary
        run: |
          cd app
          go mod download
          mkdir -p ../bin
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o ../bin/forgeturl-server .
          file ../bin/forgeturl-server || true

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ECS_KEY }}

      - name: Add ECS host to known_hosts
        run: |
          ssh-keyscan -H ${{ secrets.ECS_HOST }} >> ~/.ssh/known_hosts
          
      - name: Prepare Production Server Environment
        run: |
          # è®¾ç½®ç¯å¢ƒå˜é‡é¿å… tput è­¦å‘Š
          export TERM=xterm-256color
          
          # æ£€æŸ¥å¹¶å®‰è£… rsyncï¼ˆå¦‚æœéœ€è¦ï¼‰
          echo "Checking rsync on production server..."
          ssh ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }} "
            export TERM=xterm-256color
            if ! command -v rsync &> /dev/null; then
              echo 'rsync not found, installing...'
              sudo apt-get update -qq
              sudo apt-get install -y rsync
              echo 'rsync installed successfully'
            else
              echo 'rsync already available'
            fi
            echo 'SSH connection test successful'
          "

      - name: Blue-Green Deployment
        run: |
          # è®¾ç½®ç¯å¢ƒå˜é‡é¿å… tput è­¦å‘Š
          export TERM=xterm-256color
          
          # ç¡®å®šç›®æ ‡éƒ¨ç½²ç›®å½•
          TARGET_DIR=$(ssh ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }} "
            export TERM=xterm-256color
            set -e
            APP_DIR=/data/app/forgeturl-server/prod
            BLUE=\$APP_DIR/main-blue
            GREEN=\$APP_DIR/main-green
            CURRENT=\$(readlink \$APP_DIR/main || echo \"\")

            if [ \"\$CURRENT\" = \"\$BLUE\" ]; then
              echo \$GREEN
            else
              echo \$BLUE
            fi
          ")
          
          echo "Deploying to $TARGET_DIR..."
          
          # åŒæ­¥ä»£ç åˆ°ç›®æ ‡ç›®å½•
          rsync -avz ./bin/forgeturl-server ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }}:$TARGET_DIR/
          
          # åŒæ­¥ systemd service æ–‡ä»¶åˆ°ç›®æ ‡ç›®å½•
          rsync -avz ./app/conf/forgeturl-service-prod.service ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }}:$TARGET_DIR/conf/

          # å®‰è£…/æ›´æ–°ç”Ÿäº§ç¯å¢ƒçš„ systemd service æ–‡ä»¶
          ssh ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }} "
            export TERM=xterm-256color
            SERVICE_FILE='/etc/systemd/system/forgeturl-server-prod.service'
            SOURCE_FILE='$TARGET_DIR/conf/forgeturl-service-prod.service'
            
            # æ£€æŸ¥æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ ! -f \$SOURCE_FILE ]; then
              echo 'âŒ Service source file not found: \$SOURCE_FILE'
              exit 1
            fi
            
            # æ£€æŸ¥æ˜¯å¦éœ€è¦å®‰è£…æˆ–æ›´æ–°æœåŠ¡æ–‡ä»¶
            if [ ! -f \$SERVICE_FILE ]; then
              echo 'ğŸ“¦ Installing new production service file...'
              sudo cp \$SOURCE_FILE \$SERVICE_FILE
              sudo systemctl daemon-reload
              echo 'âœ… Production service file installed'
            else
              # æ¯”è¾ƒæ–‡ä»¶å†…å®¹
              if ! cmp -s \$SOURCE_FILE \$SERVICE_FILE; then
                echo 'ğŸ”„ Production service file content differs, updating...'
                sudo cp \$SOURCE_FILE \$SERVICE_FILE
                sudo systemctl daemon-reload
                echo 'âœ… Production service file updated'
              else
                echo 'âœ… Production service file content is identical, skipping update'
              fi
            fi
          "
          
          # åˆ‡æ¢è½¯é“¾æ¥å¹¶é‡å¯æœåŠ¡
          ssh ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }} "
            export TERM=xterm-256color
            set -e
            APP_DIR=/data/app/forgeturl-server/prod
            
            echo \"Switching symlink to $TARGET_DIR...\"
            ln -sfn $TARGET_DIR \$APP_DIR/main
            
            echo \"Restarting service...\"
            sudo systemctl restart forgeturl-server-prod.service
            sleep 2
            sudo systemctl status forgeturl-server-prod.service --no-pager
            
            echo \"âœ… Deployment complete. Now running from $TARGET_DIR\"
          "

  # =============================
  # æ‰‹åŠ¨è§¦å‘å›æ»š
  # =============================
  rollback:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'rollback'
    name: Rollback to Selected Version
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ECS_KEY }}

      - name: Add ECS host to known_hosts
        run: |
          ssh-keyscan -H ${{ secrets.ECS_HOST }} >> ~/.ssh/known_hosts

      - name: Detect Current Version
        run: |
          # è®¾ç½®ç¯å¢ƒå˜é‡é¿å… tput è­¦å‘Š
          export TERM=xterm-256color
          
          ssh ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }} "
            export TERM=xterm-256color
            APP_DIR=/data/app/forgeturl-server/prod
            CURRENT=\$(readlink \$APP_DIR/main || echo \"none\")
            echo \"ğŸ” å½“å‰ç”Ÿäº§ç¯å¢ƒè¿è¡Œç‰ˆæœ¬: \$CURRENT\"
          "

      - name: Rollback Deployment
        run: |
          # è®¾ç½®ç¯å¢ƒå˜é‡é¿å… tput è­¦å‘Š
          export TERM=xterm-256color
          
          ssh ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }} "
            export TERM=xterm-256color
            set -e
            APP_DIR=/data/app/forgeturl-server/prod
            TARGET_DIR=\$APP_DIR/main-${{ github.event.inputs.target }}

            if [ ! -d \$TARGET_DIR ]; then
              echo 'âŒ ç›®æ ‡ç›®å½•ä¸å­˜åœ¨: \$TARGET_DIR'
              exit 1
            fi

            echo 'ğŸ”„ åˆ‡æ¢è½¯é“¾åˆ°: \$TARGET_DIR'
            ln -sfn \$TARGET_DIR \$APP_DIR/main

            echo 'ğŸš€ é‡å¯æœåŠ¡...'
            sudo systemctl restart forgeturl-server-prod.service
            sleep 2
            sudo systemctl status forgeturl-server-prod.service --no-pager

            echo 'âœ… å›æ»šå®Œæˆï¼Œç°åœ¨è¿è¡Œäº: \$TARGET_DIR'
          "
