name: Deploy and Rollback

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      action:
        description: "é€‰æ‹©è¦æ‰§è¡Œçš„æ“ä½œ"
        required: true
        default: "rollback"
        type: choice
        options:
          - rollback
      target:
        description: "å›æ»šåˆ°å“ªä¸ªç‰ˆæœ¬ç›®å½• (blue æˆ– green)"
        required: false
        default: "blue"
        type: choice
        options:
          - blue
          - green

jobs:
  # =============================
  # éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
  # =============================
  deploy-test:
    if: github.event_name == 'push'
    name: Deploy to Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: app/go.mod
          cache: true

      - name: Build Go binary
        run: |
          cd app
          go mod download
          mkdir -p ../bin
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o ../bin/forgeturl-server .
          file ../bin/forgeturl-server || true

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ECS_KEY }}

      - name: Add ECS host to known_hosts
        run: |
          ssh-keyscan -H ${{ secrets.ECS_HOST }} >> ~/.ssh/known_hosts
          # æµ‹è¯• SSH è¿æ¥
          echo "Testing SSH connection..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }} "echo 'SSH connection test successful'"

      - name: Deploy to Test Environment
        run: |
          rsync -avz --delete ./ ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }}:/data/app/forgeturl-server/test/main
          ssh ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }} "sudo systemctl restart forgeturl-server-test.service"
          echo "âœ… Test environment deployed at /data/app/forgeturl-server/test/main"

  # =============================
  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ (è“ç»¿å‘å¸ƒ)
  # =============================
  deploy-prod:
    if: github.event_name == 'push'
    name: Deploy to Production (Blue-Green)
    runs-on: ubuntu-latest
    needs: deploy-test

    steps:
      - name: Wait for manual approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: your-github-username
          minimum-approvals: 1
          issue-title: "Approve deploy to production (blue-green)"
          issue-body: "è¯·ç¡®è®¤æµ‹è¯•ç¯å¢ƒæ— è¯¯åï¼Œæ‰¹å‡†å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒã€‚"

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: app/go.mod
          cache: true

      - name: Build Go binary
        run: |
          cd app
          go mod download
          mkdir -p ../bin
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o ../bin/forgeturl-server .
          file ../bin/forgeturl-server || true

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ECS_KEY }}

      - name: Add ECS host to known_hosts
        run: |
          ssh-keyscan -H ${{ secrets.ECS_HOST }} >> ~/.ssh/known_hosts
          # æµ‹è¯• SSH è¿æ¥
          echo "Testing SSH connection..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }} "echo 'SSH connection test successful'"

      - name: Blue-Green Deployment
        run: |
          # ç¡®å®šç›®æ ‡éƒ¨ç½²ç›®å½•
          TARGET_DIR=$(ssh ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }} "
            set -e
            APP_DIR=/data/app/forgeturl-server/prod
            BLUE=\$APP_DIR/main-blue
            GREEN=\$APP_DIR/main-green
            CURRENT=\$(readlink \$APP_DIR/main || echo \"\")

            if [ \"\$CURRENT\" = \"\$BLUE\" ]; then
              echo \$GREEN
            else
              echo \$BLUE
            fi
          ")
          
          echo "Deploying to $TARGET_DIR..."
          
          # åŒæ­¥ä»£ç åˆ°ç›®æ ‡ç›®å½•
          rsync -avz --delete ./ ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }}:$TARGET_DIR
          
          # åˆ‡æ¢è½¯é“¾æ¥å¹¶é‡å¯æœåŠ¡
          ssh ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }} "
            set -e
            APP_DIR=/data/app/forgeturl-server/prod
            
            echo \"Switching symlink to $TARGET_DIR...\"
            ln -sfn $TARGET_DIR \$APP_DIR/main
            
            echo \"Restarting service...\"
            sudo systemctl restart forgeturl-server-prod.service
            
            echo \"âœ… Deployment complete. Now running from $TARGET_DIR\"
          "

  # =============================
  # æ‰‹åŠ¨è§¦å‘å›æ»š
  # =============================
  rollback:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'rollback'
    name: Rollback to Selected Version
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ECS_KEY }}

      - name: Add ECS host to known_hosts
        run: |
          ssh-keyscan -H ${{ secrets.ECS_HOST }} >> ~/.ssh/known_hosts
          # æµ‹è¯• SSH è¿æ¥
          echo "Testing SSH connection..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }} "echo 'SSH connection test successful'"

      - name: Detect Current Version
        run: |
          ssh ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }} "
            APP_DIR=/data/app/forgeturl-server/prod
            CURRENT=\$(readlink \$APP_DIR/main || echo \"none\")
            echo \"ğŸ” å½“å‰ç”Ÿäº§ç¯å¢ƒè¿è¡Œç‰ˆæœ¬: \$CURRENT\"
          "

      - name: Rollback Deployment
        run: |
          ssh ${{ secrets.ECS_USER }}@${{ secrets.ECS_HOST }} "
            set -e
            APP_DIR=/data/app/forgeturl-server/prod
            TARGET_DIR=\$APP_DIR/main-${{ github.event.inputs.target }}

            if [ ! -d \$TARGET_DIR ]; then
              echo 'âŒ ç›®æ ‡ç›®å½•ä¸å­˜åœ¨: \$TARGET_DIR'
              exit 1
            fi

            echo 'ğŸ”„ åˆ‡æ¢è½¯é“¾åˆ°: \$TARGET_DIR'
            ln -sfn \$TARGET_DIR \$APP_DIR/main

            echo 'ğŸš€ é‡å¯æœåŠ¡...'
            sudo systemctl restart forgeturl-server-prod.service

            echo 'âœ… å›æ»šå®Œæˆï¼Œç°åœ¨è¿è¡Œäº: \$TARGET_DIR'
          "
